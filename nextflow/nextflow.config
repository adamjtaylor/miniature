// Miniature Pipeline Configuration

manifest {
    name            = 'adamjtaylor/miniature'
    author          = 'Adam Taylor'
    homePage        = 'https://github.com/adamjtaylor/miniature'
    description     = 'Create visual thumbnails from high-dimensional imaging data'
    mainScript      = 'main.nf'
    nextflowVersion = '!>=21.10.0'
    version         = '2.0.0'
}

// Default parameters
params {
    samplesheet = 'samplesheet.csv'
    outdir      = 'outputs'
    n           = 1024
    max_size    = 1024
}

// Process configuration
process {
    container = 'adamjtaylor/miniature:latest'

    withLabel: process_low {
        cpus   = { 2 * task.attempt }
        memory = { 4.GB * task.attempt }
        time   = { 1.h * task.attempt }
        maxRetries    = 3
        errorStrategy = { task.attempt <= 2 ? 'retry' : 'ignore' }
    }

    withLabel: process_medium {
        cpus   = { 4 * task.attempt }
        memory = { 8.GB * task.attempt }
        time   = { 2.h * task.attempt }
        maxRetries    = 3
        errorStrategy = { task.attempt <= 3 ? 'retry' : 'ignore' }
    }

    withLabel: process_high {
        cpus   = { 8 * task.attempt }
        memory = { 16.GB * task.attempt }
        time   = { 4.h * task.attempt }
        maxRetries    = 3
        errorStrategy = { task.attempt <= 3 ? 'retry' : 'ignore' }
    }
}

// Execution profiles
profiles {
    docker {
        docker.enabled         = true
        docker.userEmulation   = true
        singularity.enabled    = false
    }

    singularity {
        singularity.enabled    = true
        singularity.autoMounts = true
        docker.enabled         = false
    }

    local {
        docker.enabled         = false
        singularity.enabled    = false
        process.executor       = 'local'
    }

    slurm {
        process.executor       = 'slurm'
        process.queue          = 'normal'
        docker.enabled         = false
        singularity.enabled    = true
        singularity.autoMounts = true
    }

    test {
        params.max_size = 256
        params.n        = 64
    }
}

// Default to docker
docker.enabled = true

// Capture execution reports
timeline {
    enabled = true
    file    = "${params.outdir}/pipeline_info/execution_timeline.html"
}

report {
    enabled = true
    file    = "${params.outdir}/pipeline_info/execution_report.html"
}

trace {
    enabled = true
    file    = "${params.outdir}/pipeline_info/execution_trace.txt"
}

dag {
    enabled = true
    file    = "${params.outdir}/pipeline_info/pipeline_dag.svg"
}
